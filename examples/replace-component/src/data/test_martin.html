<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Indonesia Household Map - 5M+ Points</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js'></script>
    <link href='https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css' rel='stylesheet' />
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 20px;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            min-width: 280px;
        }
        
        #info h3 { 
            margin: 0 0 15px 0; 
            font-size: 16px;
            color: #333;
            border-bottom: 2px solid #0066cc;
            padding-bottom: 8px;
        }
        
        .info-row { 
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .label { 
            font-weight: 600;
            color: #666;
        }
        
        .value {
            font-weight: 400;
            color: #333;
            font-family: 'Courier New', monospace;
        }
        
        .strategy-indicator {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .strategy-sampling { background: #e3f2fd; color: #1565c0; }
        .strategy-clustering { background: #fff3e0; color: #e65100; }
        
        .toggle-container {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .toggle-btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: #0066cc;
            color: white;
        }
        
        .stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            font-size: 11px;
            color: #999;
        }

        /* Legend */
        #legend {
            position: absolute;
            bottom: 40px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 1;
        }
        
        #legend h4 {
            margin: 0 0 10px 0;
            font-size: 13px;
            font-weight: 600;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .legend-circle {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 8px;
            border: 2px solid white;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="info">
    <h3>üèòÔ∏è Indonesia Households (5M+ Points)</h3>
    <div class="info-row">
        <span class="label">Zoom Level:</span>
        <span class="value" id="zoom">-</span>
    </div>
    <div class="info-row">
        <span class="label">Data Source:</span>
        <span class="value" id="layer">-</span>
    </div>
    <div class="info-row">
        <span class="label">Sample Rate:</span>
        <span class="value" id="sample">-</span>
    </div>
    <div class="info-row">
        <span class="label">Strategy:</span>
        <span id="strategy">-</span>
    </div>
    
    <div class="toggle-container">
        <button id="toggleMethod" class="toggle-btn active" onclick="toggleVisualization()">
            Using: <span id="currentMethod">Sampling</span>
        </button>
    </div>
    
    <div class="stats">
        Total Data: 5,063,397 households<br>
        Coverage: Indonesia (95.24¬∞E - 141¬∞E)
    </div>
</div>

<div id="legend" style="display: none;">
    <h4>Cluster Size</h4>
    <div class="legend-item">
        <div class="legend-circle" style="background: #3498db; width: 12px; height: 12px;"></div>
        <span>1-100</span>
    </div>
    <div class="legend-item">
        <div class="legend-circle" style="background: #2ecc71; width: 16px; height: 16px;"></div>
        <span>100-1K</span>
    </div>
    <div class="legend-item">
        <div class="legend-circle" style="background: #f39c12; width: 20px; height: 20px;"></div>
        <span>1K-10K</span>
    </div>
    <div class="legend-item">
        <div class="legend-circle" style="background: #e74c3c; width: 24px; height: 24px;"></div>
        <span>10K-100K</span>
    </div>
    <div class="legend-item">
        <div class="legend-circle" style="background: #c0392b; width: 28px; height: 28px;"></div>
        <span>100K+</span>
    </div>
</div>

<script>
    let currentVisualization = 'sampling';
    
    const map = new maplibregl.Map({
        container: 'map',
        style: {
            version: 8,
            glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
            sources: {
                'osm': {
                    type: 'raster',
                    tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
                    tileSize: 256,
                    attribution: '¬© OpenStreetMap contributors'
                },
                'households-sampling': {
                    type: 'vector',
                    tiles: ['http://192.168.1.37:3000/household_points_tiles/{z}/{x}/{y}'],
                    minzoom: 0,
                    maxzoom: 22
                },
                'households-clustering': {
                    type: 'vector',
                    tiles: ['http://192.168.1.37:3000/household_points_clustered_tiles/{z}/{x}/{y}'],
                    minzoom: 0,
                    maxzoom: 22
                }
            },
            layers: [
                {
                    id: 'osm-layer',
                    type: 'raster',
                    source: 'osm',
                    minzoom: 0,
                    maxzoom: 22
                },
                // Sampling - Small points for low zoom
                {
                    id: 'households-sampling-low',
                    type: 'circle',
                    source: 'households-sampling',
                    'source-layer': 'household_layer',
                    maxzoom: 12,
                    layout: {
                        'visibility': 'visible'
                    },
                    paint: {
                        'circle-radius': [
                            'interpolate', ['linear'], ['zoom'],
                            0, 1.5,
                            6, 2.5,
                            9, 3.5,
                            12, 4
                        ],
                        'circle-color': '#2563eb',
                        'circle-stroke-width': 0.5,
                        'circle-stroke-color': '#fff',
                        'circle-opacity': 0.6
                    }
                },
                // Sampling - Individual points for high zoom
                {
                    id: 'households-sampling-high',
                    type: 'circle',
                    source: 'households-sampling',
                    'source-layer': 'household_layer',
                    minzoom: 12,
                    layout: {
                        'visibility': 'visible'
                    },
                    paint: {
                        'circle-radius': [
                            'interpolate', ['linear'], ['zoom'],
                            12, 3,
                            14, 4,
                            16, 5,
                            22, 8
                        ],
                        'circle-color': '#2563eb',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff',
                        'circle-opacity': 0.7
                    }
                },
                // Clustering - Halo/glow effect
                {
                    id: 'households-clustering-halo',
                    type: 'circle',
                    source: 'households-clustering',
                    'source-layer': 'household_layer',
                    maxzoom: 12,
                    layout: {
                        'visibility': 'none'
                    },
                    paint: {
                        'circle-radius': [
                            'interpolate', ['linear'], ['get', 'household_count'],
                            1, 8,
                            100, 14,
                            1000, 20,
                            10000, 28,
                            100000, 35
                        ],
                        'circle-color': [
                            'step', ['get', 'household_count'],
                            '#3498db',
                            100, '#2ecc71',
                            1000, '#f39c12',
                            10000, '#e74c3c',
                            100000, '#c0392b'
                        ],
                        'circle-opacity': 0.15,
                        'circle-blur': 0.5
                    }
                },
                // Clustering - Main circles
                {
                    id: 'households-clustering',
                    type: 'circle',
                    source: 'households-clustering',
                    'source-layer': 'household_layer',
                    maxzoom: 12,
                    filter: ['>=', ['get', 'household_count'], 10], // Filter clusters kecil
                    layout: {
                        'visibility': 'none'
                    },
                    paint: {
                        'circle-radius': [
                            'interpolate', ['exponential', 1.5], ['get', 'household_count'],
                            10, 6,
                            100, 10,
                            1000, 16,
                            10000, 24,
                            100000, 32
                        ],
                        'circle-color': [
                            'step', ['get', 'household_count'],
                            '#3498db',
                            100, '#2ecc71',
                            1000, '#f39c12',
                            10000, '#e74c3c',
                            100000, '#c0392b'
                        ],
                        'circle-stroke-width': 2,
                        'circle-stroke-color': '#ffffff',
                        'circle-opacity': [
                            'interpolate', ['linear'], ['zoom'],
                            0, 0.7,
                            6, 0.8,
                            12, 0.9
                        ]
                    }
                },
                // Clustering - Labels
                {
                    id: 'households-clustering-count',
                    type: 'symbol',
                    source: 'households-clustering',
                    'source-layer': 'household_layer',
                    maxzoom: 12,
                    filter: ['>=', ['get', 'household_count'], 100], // Only show labels for larger clusters
                    layout: {
                        'visibility': 'none',
                        'text-field': [
                            'case',
                            ['>=', ['get', 'household_count'], 100000],
                            [
                                'concat',
                                ['to-string', ['round', ['/', ['get', 'household_count'], 1000]]],
                                'K'
                            ],
                            ['>=', ['get', 'household_count'], 10000],
                            [
                                'concat',
                                ['to-string', ['round', ['/', ['get', 'household_count'], 1000]]],
                                'K'
                            ],
                            ['>=', ['get', 'household_count'], 1000],
                            [
                                'concat',
                                ['to-string', ['round', ['/', ['get', 'household_count'], 100]]],
                                '00'
                            ],
                            ['to-string', ['get', 'household_count']]
                        ],
                        'text-font': ['Noto Sans Bold'],
                        'text-size': [
                            'interpolate', ['linear'], ['get', 'household_count'],
                            100, 10,
                            1000, 11,
                            10000, 12,
                            100000, 13
                        ]
                    },
                    paint: {
                        'text-color': '#ffffff',
                        'text-halo-color': 'rgba(0,0,0,0.3)',
                        'text-halo-width': 1
                    }
                },
                // Clustering - Individual points for high zoom
                {
                    id: 'households-clustering-points',
                    type: 'circle',
                    source: 'households-clustering',
                    'source-layer': 'household_layer',
                    minzoom: 12,
                    layout: {
                        'visibility': 'none'
                    },
                    paint: {
                        'circle-radius': [
                            'interpolate', ['linear'], ['zoom'],
                            12, 3,
                            14, 4,
                            16, 5,
                            22, 8
                        ],
                        'circle-color': '#e74c3c',
                        'circle-stroke-width': 1,
                        'circle-stroke-color': '#fff',
                        'circle-opacity': 0.7
                    }
                }
            ]
        },
        center: [118, -2],
        zoom: 5
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');
    map.addControl(new maplibregl.ScaleControl(), 'bottom-right');
    map.addControl(new maplibregl.FullscreenControl(), 'top-right');

    function updateInfo() {
        const zoom = map.getZoom();
        document.getElementById('zoom').textContent = zoom.toFixed(2);
        
        let layer = '';
        let sample = '';
        let strategy = '';
        
        if (zoom <= 6) {
            layer = 't_household_points_zoom_low';
            sample = '1% (~50K points)';
            strategy = currentVisualization === 'sampling' ? 
                '<span class="strategy-indicator strategy-sampling">Random Sampling</span>' :
                '<span class="strategy-indicator strategy-clustering">100km Grid Clustering</span>';
        } else if (zoom <= 9) {
            layer = 't_household_points_zoom_medium';
            sample = '10% (~500K points)';
            strategy = currentVisualization === 'sampling' ? 
                '<span class="strategy-indicator strategy-sampling">Random Sampling</span>' :
                '<span class="strategy-indicator strategy-clustering">10km Grid Clustering</span>';
        } else if (zoom < 12) {
            layer = 't_household_points_zoom_high';
            sample = '25% (~1.2M points)';
            strategy = currentVisualization === 'sampling' ? 
                '<span class="strategy-indicator strategy-sampling">Random Sampling</span>' :
                '<span class="strategy-indicator strategy-clustering">1km Grid Clustering</span>';
        } else {
            layer = 't_household_points (full)';
            sample = '100% (5M+ points)';
            strategy = '<span class="strategy-indicator strategy-sampling">All Individual Points</span>';
        }
        
        document.getElementById('layer').textContent = layer;
        document.getElementById('sample').textContent = sample;
        document.getElementById('strategy').innerHTML = strategy;
    }

    function toggleVisualization() {
        if (currentVisualization === 'sampling') {
            currentVisualization = 'clustering';
            
            map.setLayoutProperty('households-sampling-low', 'visibility', 'none');
            map.setLayoutProperty('households-sampling-high', 'visibility', 'none');
            
            map.setLayoutProperty('households-clustering-halo', 'visibility', 'visible');
            map.setLayoutProperty('households-clustering', 'visibility', 'visible');
            map.setLayoutProperty('households-clustering-count', 'visibility', 'visible');
            map.setLayoutProperty('households-clustering-points', 'visibility', 'visible');
            
            document.getElementById('currentMethod').textContent = 'Clustering';
            document.getElementById('legend').style.display = 'block';
        } else {
            currentVisualization = 'sampling';
            
            map.setLayoutProperty('households-sampling-low', 'visibility', 'visible');
            map.setLayoutProperty('households-sampling-high', 'visibility', 'visible');
            
            map.setLayoutProperty('households-clustering-halo', 'visibility', 'none');
            map.setLayoutProperty('households-clustering', 'visibility', 'none');
            map.setLayoutProperty('households-clustering-count', 'visibility', 'none');
            map.setLayoutProperty('households-clustering-points', 'visibility', 'none');
            
            document.getElementById('currentMethod').textContent = 'Sampling';
            document.getElementById('legend').style.display = 'none';
        }
        
        updateInfo();
    }

    map.on('zoom', updateInfo);
    map.on('load', updateInfo);

    // Click handlers - Sampling
    map.on('click', 'households-sampling-high', (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <strong>Household Detail</strong><br>
                ID: ${props.id}<br>
                Household: ${props.household_id}<br>
                Polygon: ${props.polygon_id}<br>
                <small>Lat: ${props.latitude?.toFixed(6)}<br>
                Lon: ${props.longitude?.toFixed(6)}</small>
            `)
            .addTo(map);
    });

    map.on('click', 'households-sampling-low', (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <strong>Household Detail</strong><br>
                ID: ${props.id}<br>
                Household: ${props.household_id}
            `)
            .addTo(map);
    });

    // Click handlers - Clustering
    map.on('click', 'households-clustering', (e) => {
        const props = e.features[0].properties;
        const count = props.household_count;
        const formatted = count >= 1000 ? 
            (count / 1000).toFixed(1) + 'K' : 
            count.toLocaleString();
        
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <strong>Cluster Info</strong><br>
                Households: <strong style="color: #e74c3c; font-size: 16px;">${formatted}</strong><br>
                ${props.polygon_id ? `Sample Polygon: ${props.polygon_id}` : ''}
            `)
            .addTo(map);
    });

    map.on('click', 'households-clustering-points', (e) => {
        const props = e.features[0].properties;
        new maplibregl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(`
                <strong>Household Detail</strong><br>
                ID: ${props.id}<br>
                Household: ${props.household_id}<br>
                Polygon: ${props.polygon_id}
            `)
            .addTo(map);
    });

    // Cursor changes
    ['households-sampling-low', 'households-sampling-high', 'households-clustering', 'households-clustering-points'].forEach(layer => {
        map.on('mouseenter', layer, () => {
            map.getCanvas().style.cursor = 'pointer';
        });
        map.on('mouseleave', layer, () => {
            map.getCanvas().style.cursor = '';
        });
    });
</script>
</body>
</html>